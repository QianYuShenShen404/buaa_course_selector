# 认证模块

<cite>
**本文档中引用的文件**   
- [playwright_authenticator.py](file://src/playwright_authenticator.py)
- [simplified_config_manager.py](file://src/simplified_config_manager.py)
- [hybrid_course_selector.py](file://src/hybrid_course_selector.py)
- [main_v2_hybrid.py](file://main_v2_hybrid.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本项目旨在实现北航选课系统的自动化操作，核心功能是通过Playwright库自动完成SSO（单点登录）认证流程，并提取关键的认证信息用于后续的HTTP选课请求。该系统采用混合架构设计，结合了浏览器自动化与高效HTTP请求的优势，实现了稳定、快速的选课能力。认证模块作为整个系统的基础，负责获取Token、Cookie和secretVal等关键认证参数，为后续的选课操作提供必要的认证信息。

## 项目结构

```mermaid
graph TD
subgraph "src"
playwright_authenticator[playwright_authenticator.py]
simplified_config_manager[simplified_config_manager.py]
hybrid_course_selector[hybrid_course_selector.py]
http_course_executor[http_course_executor.py]
hybrid_retry_manager[hybrid_retry_manager.py]
end
main[main_v2_hybrid.py]
config[config_simple.json]
tools[tools/quick_secret_extractor.py]
readme[README.md]
main --> hybrid_course_selector
hybrid_course_selector --> playwright_authenticator
hybrid_course_selector --> http_course_executor
hybrid_course_selector --> simplified_config_manager
hybrid_course_selector --> hybrid_retry_manager
simplified_config_manager --> config
playwright_authenticator --> simplified_config_manager
http_course_executor --> simplified_config_manager
```

**图源**
- [main_v2_hybrid.py](file://main_v2_hybrid.py#L1-L50)
- [hybrid_course_selector.py](file://src/hybrid_course_selector.py#L1-L50)

**本节来源**
- [main_v2_hybrid.py](file://main_v2_hybrid.py#L1-L50)
- [src](file://src)

## 核心组件

认证模块的核心由`PlaywrightAuthenticator`类实现，该类封装了完整的SSO登录流程和认证信息提取逻辑。`AuthInfo`数据类用于统一管理提取到的认证信息，包括token、cookie、secretVal等关键字段。`SimplifiedConfigManager`类负责加载和验证配置文件，为认证过程提供必要的用户凭证和系统配置。这些组件协同工作，确保认证过程的稳定性和可靠性。

**本节来源**
- [playwright_authenticator.py](file://src/playwright_authenticator.py#L1-L100)
- [simplified_config_manager.py](file://src/simplified_config_manager.py#L1-L50)

## 架构概述

```mermaid
sequenceDiagram
participant 用户 as 用户
participant 主程序 as main_v2_hybrid.py
participant 选课器 as HybridCourseSelector
participant 认证器 as PlaywrightAuthenticator
participant 浏览器 as Playwright Browser
participant 北航SSO as 北航SSO系统
participant 选课系统 as 选课系统API
用户->>主程序 : 启动选课流程
主程序->>选课器 : 创建HybridCourseSelector实例
选课器->>认证器 : 初始化PlaywrightAuthenticator
选课器->>认证器 : 执行authenticate()
认证器->>浏览器 : 启动无头浏览器
认证器->>北航SSO : 导航至登录页面
北航SSO-->>浏览器 : 返回登录页面含iframe
认证器->>浏览器 : 在iframe中填写表单
认证器->>浏览器 : 提交登录表单
浏览器->>北航SSO : 发送登录请求
北航SSO-->>浏览器 : 重定向至选课系统
认证器->>浏览器 : 处理确认弹窗
认证器->>浏览器 : 触发课程列表API
浏览器->>选课系统 : POST /clazz/list
选课系统-->>浏览器 : 返回JSON含secretVal
认证器->>认证器 : 实时捕获secretVal
认证器->>选课器 : 返回AuthInfo对象
选课器->>主程序 : 执行HTTP选课
主程序->>用户 : 显示选课结果
```

**图源**
- [playwright_authenticator.py](file://src/playwright_authenticator.py#L1-L50)
- [hybrid_course_selector.py](file://src/hybrid_course_selector.py#L1-L50)
- [main_v2_hybrid.py](file://main_v2_hybrid.py#L1-L50)

## 详细组件分析

### Playwright认证器分析

`PlaywrightAuthenticator`类是整个认证流程的核心，它利用Playwright库的异步API精确模拟用户操作，完成从登录到信息提取的全过程。

#### 类结构与数据模型
```mermaid
classDiagram
class AuthInfo {
+token : str
+cookie : str
+secret_val : str
+batch_id : str
+course_id : str
+timestamp : Optional[float]
}
class PlaywrightAuthenticator {
-config_manager : SimplifiedConfigManager
-logger : logging.Logger
-playwright : async_playwright
-browser : Browser
-context : BrowserContext
-page : Page
-auth_info : Optional[AuthInfo]
-network_responses : List[Response]
-found_secrets : List[Dict[str, Any]]
+sso_login_url : str
+course_selection_url : str
+authenticate(username : str, password : str) AuthInfo
+_setup_browser() None
+_setup_network_monitoring() None
+_perform_sso_login(username : str, password : str) None
+_fill_login_form_in_iframe(username : str, password : str) None
+_submit_login_form() None
+_handle_post_login_confirmation_improved() None
+_trigger_course_list_api() None
+_extract_auth_info() Optional[AuthInfo]
+_get_secret_val_fast_method() str
+_get_secret_val_from_api() str
+_get_secret_val_from_page_js() str
+_get_secret_val(course_id : str) str
+_extract_from_network_responses() Optional[AuthInfo]
+_extract_from_javascript() Optional[AuthInfo]
+_extract_from_page_elements() Optional[AuthInfo]
+_get_current_cookies() str
+cleanup() None
+get_auth_info() Optional[AuthInfo]
+is_authenticated() bool
}
class PlaywrightAuthenticationError {
<<Exception>>
}
PlaywrightAuthenticator --> AuthInfo : "生成"
PlaywrightAuthenticator --> PlaywrightAuthenticationError : "抛出"
PlaywrightAuthenticator --> SimplifiedConfigManager : "依赖"
```

**图源**
- [playwright_authenticator.py](file://src/playwright_authenticator.py#L1-L50)

#### 认证流程分析
```mermaid
flowchart TD
Start([开始认证]) --> SetupBrowser["设置浏览器环境"]
SetupBrowser --> SetupNetwork["设置网络监听"]
SetupNetwork --> NavigateLogin["导航至SSO登录页"]
NavigateLogin --> FillForm["在iframe中填写表单"]
FillForm --> SubmitForm["提交登录表单"]
SubmitForm --> HandleConfirm["处理登录后确认弹窗"]
HandleConfirm --> TriggerAPI["触发课程列表API"]
TriggerAPI --> ExtractInfo["提取认证信息"]
ExtractInfo --> CheckSecret["检查secretVal"]
CheckSecret --> |已捕获| UseCaptured["使用捕获的secretVal"]
CheckSecret --> |未捕获| FastMethod["尝试_fast_method"]
FastMethod --> |成功| UseFast["使用快速方法结果"]
FastMethod --> |失败| GetSecretVal["调用_get_secret_val"]
GetSecretVal --> |成功| UseNormal["使用常规方法结果"]
GetSecretVal --> |失败| EmptySecret["设置空secretVal"]
UseCaptured --> ReturnSuccess["返回AuthInfo"]
UseFast --> ReturnSuccess
UseNormal --> ReturnSuccess
EmptySecret --> ReturnSuccess
ReturnSuccess --> End([认证完成])
style UseCaptured fill:#9f9,stroke:#333
style UseFast fill:#9f9,stroke:#333
style UseNormal fill:#9f9,stroke:#333
style ReturnSuccess fill:#9f9,stroke:#333
```

**图源**
- [playwright_authenticator.py](file://src/playwright_authenticator.py#L1-L50)

**本节来源**
- [playwright_authenticator.py](file://src/playwright_authenticator.py#L1-L988)

### 配置管理器分析

`SimplifiedConfigManager`类为整个系统提供了统一的配置管理接口，确保认证过程所需的用户凭证和系统配置能够被正确加载和验证。

```mermaid
classDiagram
class SimplifiedConfigManager {
-config_path : Path
-config_data : Optional[Dict[str, Any]]
-logger : Logger
+REQUIRED_FIELDS : Dict[str, List[str]]
+load_config() Dict[str, Any]
+_validate_config() None
+_validate_user_credentials() None
+_validate_course_info() None
+_validate_browser_config() None
+_validate_logging_config() None
+_apply_defaults() None
+get_user_credentials() Dict[str, str]
+get_course_info() Dict[str, str]
+get_browser_config() Dict[str, Any]
+get_logging_config() Dict[str, Any]
+get_config() Dict[str, Any]
}
class SimplifiedConfigValidationError {
<<Exception>>
}
SimplifiedConfigManager --> SimplifiedConfigValidationError : "抛出"
```

**图源**
- [simplified_config_manager.py](file://src/simplified_config_manager.py#L1-L50)

**本节来源**
- [simplified_config_manager.py](file://src/simplified_config_manager.py#L1-L324)

## 依赖分析

```mermaid
graph TD
main_v2_hybrid[main_v2_hybrid.py] --> hybrid_course_selector[hybrid_course_selector.py]
hybrid_course_selector --> playwright_authenticator[playwright_authenticator.py]
hybrid_course_selector --> http_course_executor[http_course_executor.py]
hybrid_course_selector --> simplified_config_manager[simplified_config_manager.py]
hybrid_course_selector --> hybrid_retry_manager[hybrid_retry_manager.py]
playwright_authenticator --> simplified_config_manager
http_course_executor --> simplified_config_manager
simplified_config_manager --> config_simple_json[config_simple.json]
style main_v2_hybrid fill:#f9f,stroke:#333
style hybrid_course_selector fill:#bbf,stroke:#333
style playwright_authenticator fill:#f96,stroke:#333
style simplified_config_manager fill:#6f9,stroke:#333
style config_simple_json fill:#999,stroke:#333
```

**图源**
- [main_v2_hybrid.py](file://main_v2_hybrid.py#L1-L50)
- [hybrid_course_selector.py](file://src/hybrid_course_selector.py#L1-L50)
- [playwright_authenticator.py](file://src/playwright_authenticator.py#L1-L50)
- [simplified_config_manager.py](file://src/simplified_config_manager.py#L1-L50)

**本节来源**
- [main_v2_hybrid.py](file://main_v2_hybrid.py#L1-L50)
- [src](file://src)

## 性能考虑
认证模块在设计时充分考虑了性能因素。通过使用无头浏览器（headless mode）和合理的`slow_mo`延迟设置，在保证操作稳定性的前提下尽可能提高了执行速度。网络监听机制采用异步事件处理，避免了轮询带来的性能开销。`_get_secret_val_fast_method`等优化策略通过直接调用API获取关键信息，减少了不必要的页面导航和等待时间。整体设计在稳定性和效率之间取得了良好平衡。

## 故障排除指南

以下是一些常见的认证失败原因及排查建议：

1.  **配置文件错误**：检查`config_simple.json`是否存在，格式是否正确，占位符是否已替换。
    - **来源**：[simplified_config_manager.py](file://src/simplified_config_manager.py#L1-L50)

2.  **网络连接问题**：确保网络通畅，能够访问北航SSO系统。
    - **来源**：[hybrid_course_selector.py](file://src/hybrid_course_selector.py#L1-L50)

3.  **登录凭证错误**：确认用户名和密码正确无误。
    - **来源**：[playwright_authenticator.py](file://src/playwright_authenticator.py#L1-L50)

4.  **页面元素定位失败**：北航SSO系统前端更新可能导致iframe ID或按钮文本变化。
    - **来源**：[playwright_authenticator.py](file://src/playwright_authenticator.py#L1-L50)

5.  **secretVal提取失败**：API响应结构可能发生变化，需要更新正则表达式或提取逻辑。
    - **来源**：[playwright_authenticator.py](file://src/playwright_authenticator.py#L1-L50)

6.  **浏览器环境问题**：Playwright依赖的Chromium浏览器可能未正确安装或存在兼容性问题。
    - **来源**：[playwright_authenticator.py](file://src/playwright_authenticator.py#L1-L50)

## 结论
Playwright认证模块通过自动化浏览器操作，成功解决了北航选课系统复杂的认证流程。其设计充分考虑了稳定性、效率和可维护性，通过多层次的secretVal提取策略和完善的异常处理机制，确保了认证过程的高成功率。该模块为整个选课系统提供了可靠的基础，是实现自动化选课的关键环节。